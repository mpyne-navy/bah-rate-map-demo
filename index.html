<!DOCTYPE html>
<meta charset="utf-8">
<style>

div#rate_table > table {
  font-family: 'Arial', sans-serif;
  font-size: 9pt;
  font-weight: 300;
  border-collapse: collapse;
  border: 1px solid gray;
  margin:auto;
}

div#rate_table > table td {
  border: 1px solid lightgray;
  padding: 4pt;
}

.state {
  fill: #ccc;
}

.common_mha {
  fill: #eee;
}

.nation-boundary {
  stroke: black;
  stroke-width: 1.5px;
  fill: lightgray;
}

.mha-boundary {
/*  fill: none; */
  stroke: #bbbcc3;
  stroke-width: 0.2px;
}

.state.selected {
  fill: orange;
  stroke: #000;
}

.hovered {
  fill: orange;
}

#mha_label {
  font-size: 14pt;
  font-family: "Linux Libertine O", "Lucida Sans", "Helvetica", "Arial", sans-serif;
  text-align: center;
  padding: 10pt;
}

</style>
<body>
<h1>BAH Rate Map, calendar year 2023</h1>

<form>
<fieldset>
<label id="lbl_use_depn_check"> <input type="checkbox" id="use_depn_check">Use with-dependent rate</input></label>
<br><br>
<label id="lbl_paygrade">Paygrade to use <select id="paygrade">
    </select></label>
</fieldset>
</form>

<div id="rate_table">
</div>

<div id="loading_banner">
<h2>Loading rate data...</h2>
</div>

<div id="mha_label">Hover the map to see</div>

<script src="https://d3js.org/d3.v7.min.js" charset="utf-8"></script>
<script src="https://d3js.org/topojson.v1.min.js"></script>
<script>

var width = 1080,
    height = 800;

var projection = d3.geoAlbersUsa()
    .scale(1400)
    .translate([width / 2, height / 2]);

var path = d3.geoPath()
    .projection(projection);

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

var scale = d3.scaleSequential(d3.interpolateTurbo)
    .domain([500, 5000]); // Reset once data is loaded

// We color-code based on selected paygrade and whether dependents are present
// or not.  This is based on data that must be loaded separately as well, so
// if the data hasn't loaded yet, use a null scale.

var wdepn_rate_tbl = null;
var nodepn_rate_tbl = null;
var use_depns = false;
var selected_rate_col = 5; // E5 by default

function update_rates()
{
  var rate_tbl = use_depns ? wdepn_rate_tbl : nodepn_rate_tbl;

  var mha_paths = svg.selectAll("path.mha-boundary");
  if(use_depns) {
    mha_paths.style("fill", d => scale(d.depnRate  [selected_rate_col]));
  } else {
    mha_paths.style("fill", d => scale(d.nodepnRate[selected_rate_col]));
  }
}

function remove_loading_banner()
{
  d3.select("#loading_banner").remove();

  let minRate = 99999999, maxRate = 0;

  wdepn_rate_tbl.map((row) => {
    const rowData = row.slice(1);
    minRate = Math.min(minRate, d3.min(rowData));
    maxRate = Math.max(maxRate, d3.max(rowData));
  });
  nodepn_rate_tbl.map((row) => {
    const rowData = row.slice(1);
    minRate = Math.min(minRate, d3.min(rowData));
    maxRate = Math.max(maxRate, d3.max(rowData));
  });

  console.log(`Min rate is ${minRate}, max rate is ${maxRate}`);
  scale.domain([minRate, maxRate]);
}

var mapPromise = d3.json("us_dod_mha.topo.json").then((us) => {
  const getRate = function(d) {
    return use_depns
        ? d.depnRate  [selected_rate_col]
        : d.nodepnRate[selected_rate_col];
  }

  const showMHA = function(ev, d) {
    var mha_feature = d3.select(this);
    var id = d.id;
    var svg_id = '#path-' + id;
    var hoverText = `${id}: \$${getRate(d)}`;

    d3.select("#mha_label").text(hoverText);
    mha_feature.classed("hovered", true);

    // Update table of all paygrade rates for this MHA
    var rate_tbl = use_depns ? wdepn_rate_tbl : nodepn_rate_tbl;
    var rate_data = rate_tbl.filter(row => row[0] == id);
    if(rate_data.length != 1) {
      console.error("Unable to find rates for MHA " + id);
      return;
    }
    rate_data = rate_data[0]; // We got an array back with all (1) result.

    var enl_row = rate_data.slice(1, 10);
    var war_row = rate_data.slice(10, 15);
    var pri_row = rate_data.slice(15, 18);
    var off_row = rate_data.slice(18, 28);

    d3.select("#rate_table table tbody")
      .selectAll('tr')
      .data([enl_row, war_row, pri_row, off_row])
      .selectAll('td:not(:first-child)') // don't overwrite label
      .data(d => d)
      .text(d => d);
  };

  const hideMHA = function(ev, d) {
    var mha_feature = d3.select(this);
    var mha_elem = mha_feature.datum();
    var id = mha_elem.id;
    var svg_id = '#path-' + id;

    d3.select("#mha_label").text('Hover to see');
    mha_feature.classed("hovered", false);
  };

  const pickBG = function(mha_feature) {
    var id = mha_feature.id;
    if(id && id.startsWith("ZZ")) {
      return "common_mha";
    }
    return "state";
  }

  const mhaClicked = function(ev, d) {
    console.log(`MHA clicked! datum: ${d}. HTML element:`);
    console.dir(this);
  }

  // nation outline first
  svg.append("g")
      .attr("id", "nation-outline")
    .selectAll("path")
      .data(topojson.feature(us, us.objects["us_nation"]).features)
    .enter()
      .append("path")
      .classed("nation-boundary", true)
      .attr("d", path);

  // Add MHAs as an overlay, being careful not to alter the existing nation outline <path>
  svg.selectAll("path.mha-boundary")
      .data(topojson.feature(us, us.objects["us_dod_mha"]).features)
    .enter()
      .append("path")
      .attr("id", d => `path-${d.properties.DOD_BAH_MHA}`)
      .attr("class", d => pickBG(d))
      .classed("mha-boundary", true) // add on second class
      .attr("d", path)
      .on("mousemove", showMHA)
      .on("mouseout", hideMHA)
      .on("click", mhaClicked);
});

// Embeds BAH data into the datum for each SVG <path> entry showing an MHA, so
// that later rendering has the rate information it needs to update the
// background.
function embed_rates_into_map_mhas()
{
  var rate_tbl = use_depns ? wdepn_rate_tbl : nodepn_rate_tbl;

  let depnRateMap = new Map(), nodepnRateMap = new Map();
  for (const row of wdepn_rate_tbl) {
    depnRateMap  .set(row[0], row.slice(1));
  }
  for (const row of nodepn_rate_tbl) {
    nodepnRateMap.set(row[0], row.slice(1));
  }

  var paths = svg.selectAll("path.mha-boundary");

  console.log(`Embedding rates into ${paths.size()} paths`);

  paths.each((d) => {
    // `this` is the <path> element, d is the data item
    d.depnRate   = depnRateMap  .get(d.id);
    d.nodepnRate = nodepnRateMap.get(d.id);
  });

  paths
    .filter(d => !d.depnRate || !d.nodepnRate)
    .each(d => console.log(`Removing MHA ${d.id} without BAH rates`))
    .remove();
}

// no header row, send request manually
var bahPromise1 = d3.text("bahw23.txt").then((ratetab) => {
  wdepn_rate_tbl = d3.csvParseRows(ratetab).map(row => {
    // all cols but the first are numeric and need the +val.
    return row.map((val, i) => i ? +val : val);
  });

  console.log("loaded BAH w depn data");
});

var bahPromise2 = d3.text("bahwo23.txt").then((ratetab) => {
  nodepn_rate_tbl = d3.csvParseRows(ratetab).map(row => {
    // all cols but the first are numeric and need the +val.
    return row.map((val, i) => i ? +val : val);
  });

  console.log("loaded BAH w/o depn data");
});

d3.select(self.frameElement).style("height", height + "px");

Promise.all([mapPromise, bahPromise1, bahPromise2]).then(() => {
  console.log("All data loaded, removing loading banner");
  remove_loading_banner();
  embed_rates_into_map_mhas();
  update_rates();
});

// Create dropdown-list of paygrades

var selectPaygradeList = d3.select('select#paygrade');
var ranks = new Array();
for(var i = 1; i <= 9; i++) {
    ranks.push("E" + i);
}
for(var i = 1; i <= 5; i++) {
    ranks.push("W" + i);
}
for(var i = 1; i <= 3; i++) {
    ranks.push("O" + i + "E");
}
for(var i = 1; i <= 10; i++) {
    ranks.push("O" + i);
}

selectPaygradeList.selectAll('option')
    .data(ranks)
  .enter()
    .append('option')
    .attr("value", (d, i) => i + 1)
    .text(d => d)
  .filter((d) => d == "E5")
    .attr("selected", true);

selectPaygradeList.on('change', function(ev, d) {
    selected_rate_col = +this.value;
    console.log (`Selected rate is ${selected_rate_col}`);
    update_rates();
});

d3.select("#use_depn_check").on('change', function(ev, d) {
    use_depns = this.checked;
    update_rates();
});

// Build table of per-grade rates for the hovered MHA

// 4x11 array of data (after head).
var rate_table_rows = new Array;

const row_labels = ['E1-E9', 'W1-W5', 'O1E-O3E', 'O1-O10'];
for(const row_label of row_labels) {
    var row_array = new Array(11);
    row_array.fill(''); // 2nd cell until last reset by data-join
    row_array[0] = row_label;
    rate_table_rows.push(row_array);
}

// Header row, first cell will be reset by datajoin
var header_row = [''];
for(var i = 1; i <= 10; i++) {
    header_row.push('PG' + i);
}

var table = d3.select("#rate_table").append('table');
var table_head = table.append('thead').append('tr');
table_head.selectAll('td')
    .data(header_row)
  .enter()
    .append('td')
    .text(d => d);

var table_rows = table.append('tbody');
var table_row = table_rows.selectAll('tr')
    .data(rate_table_rows)
  .enter()
    .append('tr');

table_row.selectAll('td')
    .data(d => d)
  .enter()
    .append('td')
    .text(d => d);

</script>

<!-- Each row looks like
AK400,2034.00,2034.00,2034.00,2034.00,2454.00,2472.00,2532.00,2625.00,2787.00,2475.00,2574.00,2688.00,2829.00,3000.00,2547.00,2667.00,2850.00,2466.00,2469.00,2685.00,3057.00,3324.00,3351.00,3378.00,3378.00,3378.00,3378.00

stored in separate files for BAH w/ dependents and w/out dependents.  Goes in order E1-E9, W1-CW5, O1E-O3E, then O1-O10.

In the example above:
AK400
E1-E9   2034.00,2034.00,2034.00,2034.00,2454.00,2472.00,2532.00,2625.00,2787.00,
W1-W5   2475.00,2574.00,2688.00,2829.00,3000.00,
O1E-O3E 2547.00,2667.00,2850.00,
O1-O10  2466.00,2469.00,2685.00,3057.00,3324.00,3351.00,3378.00,3378.00,3378.00,3378.00
-->
<!-- vim: set sw=2: -->
